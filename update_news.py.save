mport subprocess
import os
import requests
import datetime

# Telegram Configuration
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.environ.get("TELEGRAM_CHAT_ID")

def send_telegram_alert(message):
    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        print("âš ï¸ í…”ë ˆê·¸ë¨ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {
        "chat_id": TELEGRAM_CHAT_ID,
        "text": message,
        "parse_mode": "HTML"
    }
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            print("âœ… í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ.")
        else:
            print(f"âŒ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {response.text}")
    except Exception as e:
        print(f"âŒ í…”ë ˆê·¸ë¨ ì—°ê²° ì˜¤ë¥˜: {e}")

def update_dashboard_news():
    print("--- ğŸš€ ì§€íœ˜ì†Œ 4.0 ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘ ---")
    
    # 1. ë‰´ìŠ¤ ì…ë ¥ íŒŒì¼ í™•ì¸
    input_file = 'news_input.txt'
    if not os.path.exists(input_file):
        print(f"âŒ ì—ëŸ¬: {input_file} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‰´ìŠ¤ë¥¼ ë¨¼ì € ë³µë¶™í•´ ì£¼ì„¸ìš”.")
        return

    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            news_text = f.read()
            
        # 2. JSON íŒŒì¼ ì €ì¥
        with open('news.json', 'w', encoding='utf-8') as f:
            f.write(news_text)
        print("âœ… news.json íŒŒì¼ ê°±ì‹  ì™„ë£Œ.")

        # 3. ê¹ƒí—ˆë¸Œ ì „ì†¡
        print("ğŸ“¡ ê¹ƒí—ˆë¸Œ ë³¸ë¶€ë¡œ ì‹ í˜¸ ì†¡ì¶œ ì¤‘...")
        subprocess.run(["git", "add", "news.json"], check=True)
        subprocess.run(["git", "commit", "-m", "Manual Daily Update"], check=True)
        
        # git push ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
        push_result = subprocess.run(["git", "push", "origin", "main"], capture_output=True, text=True)
        
        if push_result.returncode == 0:
            print("ğŸ‰ ì—…ë°ì´íŠ¸ ì„±ê³µ! ì§€íœ˜ì†Œ í™”ë©´ì„ í™•ì¸í•˜ì„¸ìš”.")
            
            # 4. í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡
            today_date = datetime.datetime.now().strftime("%Y-%m-%d")
            telegram_msg = (
                f"<b>[Farmerstree ì§€íœ˜ì†Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼]</b>\n"
                f"ğŸ“… ì¼ì: {today_date}\n\n"
                f"âœ… <b>ë‰´ìŠ¤ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.</b>\n\n"
                f"ğŸ“° <b>ì˜¤ëŠ˜ì˜ ìš”ì•½:</b>\n"
                f"{news_text[:200]}..." # ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 200ìë¡œ ì œí•œí•˜ê±°ë‚˜, í•„ìš”ì‹œ ì „ì²´ ì „ì†¡
            )
            # ë§Œì•½ ì „ì²´ ë‚´ìš©ì„ ë³´ë‚´ê³  ì‹¶ë‹¤ë©´ news_textë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©. 
            # ì‚¬ìš©ì ìš”ì²­: "ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ ìš”ì•½ë³¸" -> 200ì ì •ë„ê°€ ì ë‹¹í•  ë“¯ í•˜ì§€ë§Œ, 
            # "ìš”ì•½ë³¸"ì´ news_input.txt ìì²´ë¼ë©´ ì „ì²´ë¥¼ ë³´ë‚´ëŠ” ê²Œ ë§ì„ ìˆ˜ë„ ìˆìŒ. 
            # ì¼ë‹¨ ì „ì²´ë¥¼ ë³´ë‚´ë˜ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 4096ì ì œí•œ ê³ ë ¤í•´ì•¼ í•¨.
            # ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ì•ë¶€ë¶„ + ë§í¬ ìœ ë„ ë“±ìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜, ê·¸ëƒ¥ í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ë³´ëƒ„.
            # ì‚¬ìš©ìì˜ ìš”ì²­ "ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ ìš”ì•½ë³¸ì„ ë‚´ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡" -> news_textê°€ ìš”ì•½ë³¸ì´ë¼ê³  ê°€ì •.
            
            if len(news_text) > 3000:
                 telegram_msg = (
                    f"<b>[Farmerstree ì§€íœ˜ì†Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼]</b>\n"
                    f"ğŸ“… ì¼ì: {today_date}\n\n"
                    f"âœ… <b>ë‰´ìŠ¤ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.</b>\n\n"
                    f"ğŸ“° <b>ì˜¤ëŠ˜ì˜ ë‚´ìš© (ì¼ë¶€):</b>\n"
                    f"{news_text[:3000]}\n\n(ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ ì¤‘ëµë¨)"
                )
            else:
                 telegram_msg = (
                    f"<b>[Farmerstree ì§€íœ˜ì†Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼]</b>\n"
                    f"ğŸ“… ì¼ì: {today_date}\n\n"
                    f"âœ… <b>ë‰´ìŠ¤ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.</b>\n\n"
                    f"ğŸ“° <b>ì˜¤ëŠ˜ì˜ ë‚´ìš©:</b>\n"
                    f"{news_text}"
                )

            send_telegram_alert(telegram_msg)
            
        else:
            print(f"âŒ ê¹ƒí—ˆë¸Œ í‘¸ì‹œ ì‹¤íŒ¨: {push_result.stderr}")

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    update_dashboard_news()
